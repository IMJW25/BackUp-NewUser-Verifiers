<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Login Page</title>
</head>
<body>
  <h2>ì‚¬ìš©ì ë¡œê·¸ì¸</h2>
  <form id="loginForm">
    <label>ë‹‰ë„¤ì„: <input type="text" id="nickname" required></label><br><br>
    <label>ì§€ê°‘ ì£¼ì†Œ: <input type="text" id="wallet" required></label><br><br>
    <label>ë§í¬ ì…ë ¥: <input type="text" id="userLink" placeholder="https://example.com"></label><br><br>
    <button type="submit">Send</button>
  </form>

<!--HTMLì— ìŠ¹ì¸ ëŒ€ê¸° ë©”ì‹œì§€ ì˜ì—­ ì¶”ê°€-->
<div id="waitingMessage" style="display:none; padding:10px; background:#ffffcc; border:1px solid #ccc; margin-top:20px;">
  ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const form = document.getElementById('loginForm');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const nickname = document.getElementById('nickname').value.trim();
    const wallet = document.getElementById('wallet').value.trim();

    if (!nickname || !wallet) {
      alert('ë‹‰ë„¤ì„ê³¼ ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    try {
      const res = await fetch('/api/registerUser', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nickname, wallet })
      });
      const data = await res.json();

      if (res.ok && data.status === 'success') {
        socket.emit('registerUser', { wallet, nickname }); // ì„œë²„ì— ì†Œì¼“ ë“±ë¡
        socket.emit('requestEntry', { wallet, nickname });  // ìŠ¹ì¸ ìš”ì²­ ì‹œì‘
        document.getElementById('waitingMessage').style.display = 'block';
      } else if (data.status === 'existing') {
        alert('ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.');
        // í•„ìš” ì‹œ ë°”ë¡œ í˜ì´ì§€ ì´ë™ ì²˜ë¦¬
      } else {
        alert('ì‚¬ìš©ì ë“±ë¡ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    } catch (e) {
      alert('í†µì‹  ì˜¤ë¥˜: ' + e.message);
    }
  });

  // ìŠ¹ì¸ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  socket.on('verificationCompleted', ({ approved }) => {
    console.log("ğŸ“© ì„œë²„ë¡œë¶€í„° verificationCompleted ì´ë²¤íŠ¸ ìˆ˜ì‹ :", approved);
    if (approved) {
      alert('ì…ì¥ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ì´ë™í•©ë‹ˆë‹¤.');

      const nickname = document.getElementById('nickname').value.trim();
      const wallet = document.getElementById('wallet').value.trim();
      const userLink = document.getElementById('userLink').value.trim();

      const query = `nickname=${encodeURIComponent(nickname)}&wallet=${encodeURIComponent(wallet)}&link=${encodeURIComponent(userLink)}`;
      console.log(`ğŸŒ page2.htmlë¡œ ì´ë™: ${query}`);

      window.location.href = `page2.html?${query}`;
    } else {
      alert('ì…ì¥ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  });
</script>


</body>
</html>