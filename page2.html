<!--page2.html-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì±„íŒ… & ë§í¬</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chatBox { border: 1px solid #ccc; padding: 10px; width: 100%; height: 300px; overflow-y: auto; margin-bottom: 10px; }
    #messageInput { width: 80%; padding: 5px; }
    #sendBtn { padding: 5px 10px; }
    .message { margin-bottom: 5px; }
    .from { font-weight: bold; margin-right: 5px; }
  </style>
</head>
<body>
  <h1>ì±„íŒ… & ë§í¬ í˜ì´ì§€</h1>

  <div>
    <label>ë‹‰ë„¤ì„: <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥"></label>
  </div>

  <h2>ì±„íŒ…</h2>
  <div id="chatBox"></div>
  <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥">
  <button id="sendBtn">Send</button>

  <script>

    const nicknameInput = document.getElementById('nickname');
    const params = new URLSearchParams(window.location.search);
    const myWallet = params.get('wallet');
    const nickname = params.get('nickname');

    if (nickname) nicknameInput.value = nickname;

    const socket = io();

    socket.on('connect', () => {
      console.log('myWallet ê°’:', myWallet);
     socket.emit('registerValidator', { wallet: myWallet, nickname: nicknameInput.value });
     console.log('registerValidator ì´ë²¤íŠ¸ ì „ì†¡:', myWallet, nicknameInput.value);
    });


    if (!myWallet) {
      alert('ì§€ê°‘ì£¼ì†Œ ì—†ì–´ì„œ ê¸°ëŠ¥ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }
    const wallet = params.get('wallet');

    // ë‹‰ë„¤ì„ inputì— ìë™ ì±„ìš°ê¸°
    if (nickname) nicknameInput.value = nickname;

    // ì„œë²„ì— ì‚¬ìš©ì ë“±ë¡
    if (nickname && wallet) {
      // socket.emit('registerUser', { wallet: wallet, nickname });
      // // ì‹ ê·œ ì‚¬ìš©ì ì…ì¥ ê²€ì¦ ìš”ì²­ ë³´ë‚´ê¸°
      // socket.emit('requestEntry', { wallet, nickname });
    }

    // ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ ì•Œë¦¼
    socket.on('waitingForApproval', () => {
      alert('ì‹ ê·œ ì‚¬ìš©ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ê²€ì¦ìë“¤ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      // UI ì œì–´ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬
    });

    // ìŠ¹ì¸ ì™„ë£Œ/ê±°ë¶€ ì—¬ë¶€ ì²˜ë¦¬
    let movedOnVerification = false;

    socket.on('verificationCompleted', ({ approved }) => {
      if (sessionStorage.getItem('movedOnVerification')) return; // ì´ë¯¸ ì²˜ë¦¬í–ˆìœ¼ë©´ ë¬´ì‹œ
      sessionStorage.setItem('movedOnVerification', 'true');    // ìµœì´ˆ ì²˜ë¦¬ í‘œì‹œ

      if (approved) {
       alert('ì…ì¥ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        // í˜ì´ì§€ ì´ë™ì„ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì§„í–‰í•˜ê±°ë‚˜, ì´ë™ ì „ì— ìƒíƒœ ì €ì¥
        setTimeout(() => {
         window.location.href = `page2.html?nickname=${encodeURIComponent(nicknameInput.value)}&wallet=${encodeURIComponent(wallet)}`;
        }, 500);
     } else {
        alert('ì…ì¥ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    });



    // ê¸°ì¡´ ì±„íŒ… ë¡œê·¸ ìˆ˜ì‹ 
    socket.on('chatLogs', (logs) => {
      chatBox.innerHTML = ''; 
      logs.forEach(log => addMessage(log.fromUser, log.message));
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ 
    socket.on('receiveMessage', ({ fromUser, message }) => {
      addMessage(fromUser, message);
    });

Â  Â  // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ìˆ˜ì‹  ë° ìŠ¹ì¸ ìš”ì²­ ì²˜ë¦¬
    socket.on('verificationRequested', ({ candidate, nickname, message, validators }) => {
      console.log('ğŸ”” verificationRequested ì´ë²¤íŠ¸ ìˆ˜ì‹ :', candidate, nickname, message, validators);
      alert(`ìƒˆë¡œìš´ ì‚¬ìš©ì ${nickname} (${candidate})ê°€ ${message}`);

      const approve = confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      socket.emit('vote', { candidate, verifier: myWallet, approve });
    });




    function addMessage(fromUser, message) {
      const div = document.createElement('div');
      div.classList.add('message');

      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const formattedMessage = message.replace(urlRegex, url => 
        `<a href="#" class="chat-link" data-url="${url}">${url}</a>`
      );

      div.innerHTML = `<span class="from">${fromUser}:</span> ${formattedMessage}`;
      chatBox.appendChild(div);
      div.scrollIntoView();

      // ë§í¬ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
      div.querySelectorAll('.chat-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const url = link.dataset.url;
          socket.emit('linkClicked', { fromUser, link: url });
          console.log('ë§í¬ í´ë¦­:', fromUser, url);
        });
      });
    }

    // ë©”ì‹œì§€ ì „ì†¡
    sendBtn.addEventListener('click', () => {
      const fromUser = nicknameInput.value.trim();
      const message = messageInput.value.trim();

      if (!fromUser || !message) {
        alert('ë‹‰ë„¤ì„ê³¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      const toUser = ''; // í•„ìš”ì‹œ ì‹¤ì œ ìˆ˜ì‹ ì ë‹‰ë„¤ì„ í• ë‹¹
      socket.emit('sendMessage', { fromUser, message, toUser });
      messageInput.value = '';
    });

    // ì—”í„°í‚¤ ì „ì†¡
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });
  </script>
</body>
</html>
